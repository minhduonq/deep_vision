<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Vision - Ch·ªânh S·ª≠a ·∫¢nh AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f0f5;
        }

        .upload-section.dragover {
            background: #e8e9ff;
            border-color: #764ba2;
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        .image-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .image-box h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .image-box img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .controls {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #764ba2;
            color: white;
            border-color: #764ba2;
        }

        .param-controls {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .param-control {
            margin-bottom: 15px;
        }

        .param-control label {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
            font-weight: 600;
        }

        .param-control input[type="number"],
        .param-control input[type="range"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.active {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .image-container {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® Deep Vision</h1>
            <p>Ch·ªânh s·ª≠a ·∫£nh th√¥ng minh v·ªõi Deep Learning</p>
        </header>

        <div class="content">
            <div id="message" class="message"></div>

            <div class="upload-section" id="uploadSection">
                <h2>üì§ T·∫£i ·∫£nh l√™n</h2>
                <p style="margin: 20px 0; color: #666;">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c nh·∫•n n√∫t b√™n d∆∞·ªõi</p>
                <input type="file" id="fileInput" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Ch·ªçn ·∫¢nh
                </button>
            </div>

            <div class="image-container" id="imageContainer" style="display: none;">
                <div class="image-box">
                    <h3>·∫¢nh G·ªëc</h3>
                    <img id="originalImage" src="" alt="Original">
                </div>
                <div class="image-box">
                    <h3>·∫¢nh ƒê√£ Ch·ªânh S·ª≠a</h3>
                    <img id="processedImage" src="" alt="Processed">
                </div>
            </div>

            <div class="controls" id="controls" style="display: none;">
                <h3>üéõÔ∏è Ch·ªçn Hi·ªáu ·ª®ng</h3>
                <div class="filter-grid" id="filterGrid"></div>
                <div id="paramControls" class="param-controls" style="display: none;"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="applyBtn" onclick="applyFilter()">
                        √Åp D·ª•ng Hi·ªáu ·ª®ng
                    </button>
                    <button class="btn btn-secondary" id="downloadBtn" onclick="downloadImage()" style="display: none;">
                        T·∫£i Xu·ªëng
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω ·∫£nh...</p>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let currentFilename = null;
        let selectedOperation = null;
        let operations = [];

        // Load available operations
        async function loadOperations() {
            try {
                const response = await fetch('/api/operations');
                operations = await response.json();
                displayFilters();
            } catch (error) {
                showMessage('Kh√¥ng th·ªÉ t·∫£i danh s√°ch hi·ªáu ·ª©ng', 'error');
            }
        }

        function displayFilters() {
            const filterGrid = document.getElementById('filterGrid');
            filterGrid.innerHTML = '';
            
            operations.forEach(op => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = op.label;
                btn.onclick = () => selectOperation(op);
                filterGrid.appendChild(btn);
            });
        }

        function selectOperation(operation) {
            selectedOperation = operation;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === operation.label) {
                    btn.classList.add('active');
                }
            });

            // Display parameter controls if needed
            const paramControls = document.getElementById('paramControls');
            if (operation.params && operation.params.length > 0) {
                paramControls.style.display = 'block';
                paramControls.innerHTML = '<h4>Tham s·ªë:</h4>';
                
                operation.params.forEach(param => {
                    const controlDiv = document.createElement('div');
                    controlDiv.className = 'param-control';
                    
                    const label = document.createElement('label');
                    label.textContent = param.name.charAt(0).toUpperCase() + param.name.slice(1);
                    controlDiv.appendChild(label);
                    
                    const input = document.createElement('input');
                    input.type = param.type;
                    input.id = `param-${param.name}`;
                    input.value = param.default;
                    input.min = param.min || 0;
                    input.max = param.max || 100;
                    input.step = param.step || 1;
                    controlDiv.appendChild(input);
                    
                    paramControls.appendChild(controlDiv);
                });
            } else {
                paramControls.style.display = 'none';
            }
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // Drag and drop handling
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('Vui l√≤ng ch·ªçn file ·∫£nh', 'error');
                return;
            }

            currentFile = file;
            showLoading(true);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentFilename = data.filename;
                    showMessage('T·∫£i ·∫£nh l√™n th√†nh c√¥ng!', 'success');
                    displayOriginalImage();
                    document.getElementById('controls').style.display = 'block';
                    document.getElementById('imageContainer').style.display = 'grid';
                } else {
                    showMessage(data.error || 'L·ªói t·∫£i ·∫£nh l√™n', 'error');
                }
            } catch (error) {
                showMessage('L·ªói k·∫øt n·ªëi ƒë·∫øn server', 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayOriginalImage() {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('originalImage').src = e.target.result;
                document.getElementById('processedImage').src = e.target.result;
            };
            reader.readAsDataURL(currentFile);
        }

        async function applyFilter() {
            if (!selectedOperation || !currentFilename) {
                showMessage('Vui l√≤ng ch·ªçn ·∫£nh v√† hi·ªáu ·ª©ng', 'error');
                return;
            }

            showLoading(true);

            // Collect parameters
            const params = {};
            if (selectedOperation.params) {
                selectedOperation.params.forEach(param => {
                    const input = document.getElementById(`param-${param.name}`);
                    if (input) {
                        params[param.name] = parseFloat(input.value);
                    }
                });
            }

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: currentFilename,
                        operation: selectedOperation.name,
                        params: params
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('X·ª≠ l√Ω ·∫£nh th√†nh c√¥ng!', 'success');
                    document.getElementById('processedImage').src = `/api/download/${data.filename}?t=${Date.now()}`;
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    document.getElementById('downloadBtn').dataset.filename = data.filename;
                } else {
                    showMessage(data.error || 'L·ªói x·ª≠ l√Ω ·∫£nh', 'error');
                }
            } catch (error) {
                showMessage('L·ªói k·∫øt n·ªëi ƒë·∫øn server', 'error');
            } finally {
                showLoading(false);
            }
        }

        function downloadImage() {
            const filename = document.getElementById('downloadBtn').dataset.filename;
            if (filename) {
                window.location.href = `/api/download/${filename}`;
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type} active`;
            setTimeout(() => {
                messageDiv.classList.remove('active');
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('applyBtn').disabled = show;
        }

        // Initialize
        loadOperations();
    </script>
</body>
</html>
